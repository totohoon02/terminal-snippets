#!/bin/bash

### =========================
###  properties → YAML
### =========================
to_yml() {
    local dir="./src/main/resources"
    local input_file="$dir/application.properties"
    local tmp_file="$dir/.tmp_application.yml"

    if [ ! -f "$input_file" ]; then
        echo "❌ 파일을 찾을 수 없습니다: $input_file"
        return 1
    fi

    echo "🔄 properties → YAML 변환 중..."

    awk -F'=' '
    /^[[:space:]]*#/ { next }
    /^[[:space:]]*$/ { next }

    {
        key=$1
        value=$2
        gsub(/^[ \t]+|[ \t]+$/, "", key)
        gsub(/^[ \t]+|[ \t]+$/, "", value)
        n = split(key, parts, ".")
        indent=""

        for (i=1; i<n; i++) {
            printf "%s%s:\n", indent, parts[i]
            indent = indent "  "
        }

        # 리스트 인덱스 처리 (ex: key[0]=)
        match(parts[n], /(.*)\[([0-9]+)\]/, arr)
        if (arr[1] != "") {
            printf "%s%s:\n", indent, arr[1]
            indent = indent "  "
            printf "%s- %s\n\n", indent, value
        } else {
            printf "%s%s: %s\n\n", indent, parts[n], value
        }
    }' "$input_file" > "$tmp_file"

    mv "$tmp_file" "$dir/application.yml"
    rm -f "$input_file"

    echo "✅ 변환 완료: $dir/application.yml (기존 properties 삭제됨)"
}

### =========================
###  YAML → properties
### =========================
to_prop() {
    local dir="./src/main/resources"
    local input_file="$dir/application.yml"
    local tmp_file="$dir/.tmp_application.properties"

    if [ ! -f "$input_file" ]; then
        echo "❌ 파일을 찾을 수 없습니다: $input_file"
        return 1
    fi

    echo "🔄 YAML → properties 변환 중..."

    awk '
    /^[[:space:]]*#/ { next }
    /^[[:space:]]*$/ { next }

    {
        indent = match($0, /[^ ]/) - 1
        gsub(/^ +/, "", $0)
        gsub(/"/, "", $0)
        gsub(/'\''/, "", $0)

        # 리스트 항목 처리 (- value)
        if ($1 == "-") {
            value = $2
            level = indent / 2
            idx[level]++
            fullkey = path[0]
            for (i=1; i<=level; i++) fullkey = fullkey "." path[i]
            print fullkey "[" idx[level]-1 "]=" value
            next
        }

        split($0, kv, ":")
        key = kv[1]
        value = kv[2]
        sub(/^ +/, "", value)

        level = indent / 2
        path[level] = key
        delete path[level+1]

        if (value != "") {
            fullkey = path[0]
            for (i=1; i<=level; i++) fullkey = fullkey "." path[i]
            print fullkey "=" value
        }
    }' "$input_file" > "$tmp_file"

    mv "$tmp_file" "$dir/application.properties"
    rm -f "$input_file"

    echo "✅ 변환 완료: $dir/application.properties (기존 YAML 삭제됨)"
}

ycon() {
    # No input    
    if [ -z "$1" ]; then
        echo "Usage: ycon <filename>"
        echo "Example: ycon chroma"
        return 1
    fi

    # make dir    
    local dir="./src/main/resources/config"
    mkdir -p "$dir"

    # curl yml and move
    local ymlfile="$1"
    lck -y $ymlfile
    mv "${ymlfile}Config.yml" "$dir" 
}

jcon() {
    # 1️⃣ 인자 확인
    if [ -z "$1" ]; then
        echo "Usage: jcon <filename>"
        echo "Example: jcon swagger"
        return 1
    fi

    # get project name
    local project_name
    project_name=$(basename "$(pwd)")

    local target_dir="./src/main/java/${project_name}/config"
    mkdir -p "$target_dir"

    # 파일 명 및 curl
    local classFile="$1"
    classFile="$(tr '[:lower:]' '[:upper:]' <<< ${classFile:0:1})${classFile:1}"
    
    lck -j $classFile

    # 이동
    mv "${classFile}Config.java" "$target_dir/"

}
