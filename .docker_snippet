alias up="docker compose up -d"
alias down="docker compose down"
alias dps="docker ps"
alias dmgs="docker images"

pydocker() {
    echo 'FROM python:3.10-slim' > Dockerfile
    echo '' >> Dockerfile
    echo '# 1. uv 설치' >> Dockerfile
    echo 'RUN pip install uv' >> Dockerfile
    echo '' >> Dockerfile
    echo 'WORKDIR /app' >> Dockerfile
    echo '' >> Dockerfile
    echo '# 2. pyproject.toml & uv.lock 복사' >> Dockerfile
    echo 'COPY pyproject.toml uv.lock ./' >> Dockerfile
    echo '' >> Dockerfile
    echo '# 3. 의존성 설치 (재현성 보장)' >> Dockerfile
    echo 'RUN uv sync --frozen --no-dev' >> Dockerfile
    echo '' >> Dockerfile
    echo '# 4. 애플리케이션 복사' >> Dockerfile
    echo 'COPY . .' >> Dockerfile
    echo '' >> Dockerfile
    echo 'EXPOSE 8000' >> Dockerfile
    echo '' >> Dockerfile
    echo 'CMD ["uv", "run", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]' >> Dockerfile
}


jdocker() {
    cat <<EOF > Dockerfile
FROM gradle:jdk21 AS build
WORKDIR /app

# 의존성 캐싱
COPY build.gradle settings.gradle ./
RUN gradle dependencies --no-daemon > /dev/null 2>&1 || true

# 빌드
COPY src ./src
RUN gradle clean bootJar -x test --no-daemon

# 실행 환경
FROM eclipse-temurin:21-jre-jammy
WORKDIR /app

COPY --from=build /app/build/libs/*.jar app.jar

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
EOF
}

recon(){
    down
    up --build
}

drun() {
    # 인자가 정확히 3개가 아니면 사용법 안내 (포트, 이미지, 이름)
    if [ $# -ne 3 ]; then
        echo "Usage: dkrun [PORT:PORT] [IMAGE_NAME] [CONTAINER_NAME]"
        return 1
    fi

    local port_mapping=$1
    local image_name=$2
    local container_name=$3

    # 기존에 같은 이름의 컨테이너가 있다면 강제 삭제 (교체 목적)
    docker rm -f "$container_name" 2>/dev/null
    
    # 컨테이너 실행
    docker run -d -p "$port_mapping" --name "$container_name" "$image_name"
    
    echo "✅ Container '$container_name' is running on $port_mapping"
}

dbuild() {
    if [ -z "$1" ]; then
        echo "사용법: build [이미지이름]"
        return 1
    fi
    
    docker buildx build --load -t "$1" .
}

drmi(){
    if [ -n "$1" ]; then
        # 1. 인자($1)가 있는 경우: 해당 이미지 이름을 삭제
        echo "Deleting image: $1"
        docker rmi "$1"
    else
        # 2. 인자가 없는 경우: 기존 로직(dangling 이미지 삭제) 실행
        echo "No image name provided. Deleting dangling images..."
        for image_id in $(docker images --filter "dangling=true" -q); do
            docker rmi "$image_id"
        done
    fi
}

dxc() {
    if [ -z "$1" ]; then
        echo "Usage: dxc <container_name>"
        return 1
    fi
    docker exec -it "$1" bash
}

drmc() {
    if [ -z "$1" ]; then
        echo "Usage: drmv <container_name>"
        return 1
    fi
    docker rm -f "$1"
}
